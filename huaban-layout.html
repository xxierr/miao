<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    html {
      background-color: silver;
      overflow-y: scroll;
    }
    body {
      margin: 8px;
    }
    section {
      margin: auto;
      position: relative;
    }

    img {
      display: block;
      outline: 1px solid white;
      outline-offset: 1px;
      position: absolute;
      transition: 0.3s;
    }
  </style>
</head>
<body>
  <section></section>
  <script src="https://unpkg.com/lodash"></script>
  <script>
    var cats = [
      {
        "url": "photo-108273877.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/photo-108273877.jpg",
        "width": 1170,
        "height": 780
      },
      {
        "url": "photo-115203323.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/photo-115203323.jpg",
        "width": 1170,
        "height": 780
      },
      {
        "url": "photo-23583825.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/photo-23583825.jpg",
        "width": 2048,
        "height": 1536
      },
      {
        "url": "stock-photo-123942383.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-123942383.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-124559545.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-124559545.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-132046989.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132046989.jpg",
        "width": 1170,
        "height": 780
      },
      {
        "url": "stock-photo-132118343.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132118343.jpg",
        "width": 2000,
        "height": 1339
      },
      {
        "url": "stock-photo-132311221.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132311221.jpg",
        "width": 1920,
        "height": 1080
      },
      {
        "url": "stock-photo-132586903.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132586903.jpg",
        "width": 2000,
        "height": 1334
      },
      {
        "url": "stock-photo-135203031.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-135203031.jpg",
        "width": 1000,
        "height": 668
      },
      {
        "url": "stock-photo-135626379.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-135626379.jpg",
        "width": 2000,
        "height": 1500
      },
      {
        "url": "stock-photo-136947953.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-136947953.jpg",
        "width": 2000,
        "height": 1348
      },
      {
        "url": "stock-photo-138378295.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-138378295.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-138436811.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-138436811.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-142950305.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-142950305.jpg",
        "width": 2000,
        "height": 1125
      },
      {
        "url": "stock-photo-143046061.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-143046061.jpg",
        "width": 843,
        "height": 1000
      },
      {
        "url": "stock-photo-143181649.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-143181649.jpg",
        "width": 2000,
        "height": 1298
      },
      {
        "url": "stock-photo-144530143.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-144530143.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-144730939.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-144730939.jpg",
        "width": 1000,
        "height": 1000
      },
      {
        "url": "stock-photo-145414771.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-145414771.jpg",
        "width": 780,
        "height": 1170
      },
      {
        "url": "stock-photo-146038669.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-146038669.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-146231033.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-146231033.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-146914861.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-146914861.jpg",
        "width": 843,
        "height": 1000
      },
      {
        "url": "stock-photo-147877407.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-147877407.jpg",
        "width": 2000,
        "height": 1334
      },
      {
        "url": "stock-photo-147969173.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-147969173.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-148015373.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148015373.jpg",
        "width": 1170,
        "height": 781
      },
      {
        "url": "stock-photo-148704233.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148704233.jpg",
        "width": 1170,
        "height": 884
      },
      {
        "url": "stock-photo-148928293.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148928293.jpg",
        "width": 1170,
        "height": 781
      },
      {
        "url": "stock-photo-148950715.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148950715.jpg",
        "width": 1170,
        "height": 775
      },
      {
        "url": "stock-photo-21951271.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-21951271.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-21964829.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-21964829.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-22618399.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-22618399.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-31201539.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-31201539.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-34598868.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-34598868.jpg",
        "width": 542,
        "height": 768
      },
      {
        "url": "stock-photo-47252094.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-47252094.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-51980510.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-51980510.jpg",
        "width": 666,
        "height": 1000
      },
      {
        "url": "stock-photo-55601508.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-55601508.jpg",
        "width": 666,
        "height": 1000
      },
      {
        "url": "stock-photo-65681789.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-65681789.jpg",
        "width": 1840,
        "height": 1232
      },
      {
        "url": "stock-photo-70461471.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-70461471.jpg",
        "width": 1000,
        "height": 1000
      },
      {
        "url": "stock-photo-71801901.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-71801901.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-71913567.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-71913567.jpg",
        "width": 2000,
        "height": 1328
      },
      {
        "url": "stock-photo-72223295.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-72223295.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-72620185.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-72620185.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-74402039.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-74402039.jpg",
        "width": 666,
        "height": 1000
      },
      {
        "url": "stock-photo-75097491.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-75097491.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-75186237.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-75186237.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-79250373.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-79250373.jpg",
        "width": 2000,
        "height": 1325
      },
      {
        "url": "stock-photo-79692589.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-79692589.jpg",
        "width": 670,
        "height": 1000
      },
      {
        "url": "stock-photo-7979718.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-7979718.jpg",
        "width": 1024,
        "height": 680
      },
      {
        "url": "stock-photo-7980252.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-7980252.jpg",
        "width": 1024,
        "height": 680
      },
      {
        "url": "stock-photo-81390687.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-81390687.jpg",
        "width": 2000,
        "height": 1591
      },
      {
        "url": "stock-photo-81988949.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-81988949.jpg",
        "width": 667,
        "height": 1000
      },
      {
        "url": "stock-photo-83149705.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-83149705.jpg",
        "width": 775,
        "height": 1170
      }
    ]
    cats = [..._.cloneDeep(cats), ..._.cloneDeep(cats)]
    cats = [..._.cloneDeep(cats), ..._.cloneDeep(cats)]
    cats = [..._.cloneDeep(cats), ..._.cloneDeep(cats)]
    cats = [..._.cloneDeep(cats), ..._.cloneDeep(cats)]
    cats = [..._.cloneDeep(cats), ..._.cloneDeep(cats)]

    cats.forEach((it, idx) => {
      it.idx = idx
    })

    var section = document.querySelector('section')
    var prevwidth = 0
    var prevcols = 0
    var 余量 = -100
    var colwidth = 180
    var gap = 8

    function run() {
      if(window.innerWidth == prevwidth) {
        return
      } else {
        prevwidth = window.innerWidth
      }

      var cols = Math.floor( (window.innerWidth - 30) / (colwidth + gap))  //计算显示列数

      if(cols == prevcols){
        return
      }else {
        prevcols = cols
      }
      
      cats.forEach(it => {// 防止调整页面宽度后重新计算布局后有些图片显示状态不对
        it.show = false
      })
      section.innerHTML = ""  //清空section元素

      //根据列数计算section的尺寸
      var containerwidth = cols * colwidth + (cols -1) *gap
      section.style.width = containerwidth + "px"
  
      var colheights = Array(cols).fill(0)  //记录每列的高度

      for(var cat of cats){
        var mincolheight = Math.min(...colheights)  //获取最矮的列高
        var mincolidx = colheights.indexOf(mincolheight)  //获取最矮列高数组的下标

        cat.left = mincolidx * (colwidth + gap)
        cat.top = mincolheight
        cat.displaywidth = colwidth
        cat.displayheight = Math.round(colwidth * cat.height / cat.width)

        colheights[mincolidx] += cat.displayheight + gap  //计算每列的实际高度
      }

      section.style.height = Math.max(...colheights) + 'px'

      cats.filter(cat => {
        return cat.top + cat.displayheight + gap >= window.pageYOffset - 余量
          && cat.top + gap <= window.pageYOffset + window.innerHeight + 余量
      }).forEach(cat => {
        cat.show = true
        var img = document.createElement('img')
        img.dataset.idx = cat.idx
        img.src = cat.fullUrl
        img.style.width = cat.displaywidth + 'px'
        img.style.height = cat.displayheight + 'px'
        img.style.transform = `translate(${cat.left}px, ${cat.top}px)`
        img.style.opacity = '0'
        img.onload = () => {
          img.style.opacity = '1'
        }
        section.append(img)
      })

    }
    run()
    window.onresize = debounce(run, 300)

    var prevpageYoffset = 0
    window.onscroll = (e) => {
      if(Math.abs(window.pageYOffset - prevpageYoffset) < 100){
        console.log("滚动距离过短，取消")
        return
      }
      // var imgs = section.querySelectorAll('img')
      // imgs.forEach(img => {  // 把离开屏幕的图片删掉
      //   var box = img.getBoundingClientRect()
      //   if(true || window.pageYOffset > prevpageYoffset){
      //     if(box.bottom < -余量){
      //       section.removeChild(img)
      //     }
      //   }
      //   if(true || window.pageYOffset < prevpageYoffset){
      //     if(box.top > window.innerHeight + 余量){
      //       section.removeChild(img)
      //     }
      //   }
      // })

      // 计算已经显示的图片
      var showncats = cats.filter(cat => cat.show == true)
      var tobeshow = cats.filter(cat => { //计算新的滚动位置该显示的图片
        return cat.top + cat.displayheight + gap >= window.pageYOffset - 余量
          && cat.top + gap <= window.pageYOffset + window.innerHeight + 余量
      })

      //计算要离开的图片
      var leavecats = _.difference(showncats, tobeshow)
      leavecats.forEach(it => {// 标记为不显示
        it.show = false
        var img = section.querySelector(`[data-idx="${it.idx}"]`) //这样就不用上面的删除图片的判断了
        img.remove()
        console.log("-")
      })

      //计算要新增dom的图片
      var newcats = _.difference(tobeshow, showncats)
      newcats.forEach(cat => {
        cat.show = true
        var img = document.createElement('img')
        img.dataset.idx = cat.idx
        img.src = cat.fullUrl
        img.style.width = cat.displaywidth + 'px'
        img.style.height = cat.displayheight + 'px'
        img.style.transform = `translate(${cat.left}px, ${cat.top}px)`
        img.style.opacity = '0'
        img.onload = () => {
          img.style.opacity = '1'
        }
        section.append(img)
        console.log("+")
      })

      prevpageYoffset = window.pageYOffset
    }
 
    //防抖
    function debounce(f, time) {
      var taskId

      return function(...args) {
        clearTimeout(taskId)
        taskId = setTimeout(() => {
          f.call(this, ...args)
        }, time)
      }
    }

    //节流
    function throttle(f, time) {
      var scheduled = false, lastArgs
      return function(...args) {
        lastArgs = args
        if (!scheduled) {
          scheduled = true
          setTimeout(() => {
            scheduled = false
            f.call(...lastArgs)
          }, time)
        }
      }
    }

    
    var section = document.querySelector('section')
    var z = 5
    section.addEventListener('click', function(e) {
      if (e.target.matches('section > div > img')) {
        var img = e.target

        // 如果没放大，那么元素的transform为空
        if (img.style.transform == '') {
          var box = img.getBoundingClientRect()
          var cx = box.left + box.width / 2
          var cy = box.top + box.height / 2
          var vx = window.innerWidth / 2
          var vy = window.innerHeight / 2
          var movex = vx - cx
          var movey = vy - cy
          var zoomx = window.innerWidth / box.width
          var zoomy = window.innerHeight / box.height

          img.style.zIndex = z++
          img.style.transform = `translate(${movex}px, ${movey}px) scale(${Math.min(zoomx, zoomy)})`
          img.style.boxShadow = '0 0 0 10000px black'
          document.documentElement.style.overflowY = 'hidden'
          document.documentElement.style.paddingRight = '14px'
        } else {
          img.style.transform = ''
          img.style.boxShadow = ''
          document.documentElement.style.overflowY = ''
          document.documentElement.style.paddingRight = ''
        }

      }
    })
  </script>
</body>
</html>
